<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread vs Marketing Trade-off Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .subtitle {
            color: #8892b0;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 24px;
        }

        .control-section {
            margin-bottom: 28px;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-title .icon {
            font-size: 18px;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 13px;
            color: #8892b0;
        }

        .slider-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .slider-value.negative {
            color: #f87171;
        }

        .slider-value.positive {
            color: #4ade80;
        }

        .slider-value.warning {
            color: #facc15;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 10px;
            color: #666;
        }

        .output-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .output-card.primary {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .output-card.danger {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .output-label {
            font-size: 11px;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .output-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        .output-value.large {
            font-size: 48px;
        }

        .output-detail {
            font-size: 12px;
            color: #8892b0;
            margin-top: 4px;
        }

        .output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .chart-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 24px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 24px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-badge.profitable {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-badge.unprofitable {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .frontier-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .frontier-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .frontier-description {
            font-size: 13px;
            color: #8892b0;
            margin-bottom: 16px;
        }

        .frontier-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .frontier-table th,
        .frontier-table td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .frontier-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #fff;
        }

        .frontier-table th:first-child,
        .frontier-table td:first-child {
            text-align: left;
        }

        .frontier-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .frontier-table tr.selected td {
            background: rgba(34, 197, 94, 0.15);
        }

        .frontier-table tr.infeasible td {
            color: #666;
        }

        .frontier-table .max-contracts {
            color: #4ade80;
            font-weight: 600;
        }

        .nav-link {
            display: inline-block;
            color: #8892b0;
            text-decoration: none;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .nav-link:hover {
            color: #fff;
        }

        .constraint-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .constraint-box .label {
            color: #4ade80;
            font-weight: 600;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: #8892b0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .quick-btn.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            color: #4ade80;
        }

        .mode-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: #8892b0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
        }

        .efficiency-readout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .efficiency-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .efficiency-card.highlight {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .efficiency-label {
            font-size: 11px;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .efficiency-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .efficiency-value.marketing {
            color: #3b82f6;
        }

        .efficiency-value.spread {
            color: #f59e0b;
        }

        .efficiency-detail {
            font-size: 12px;
            color: #8892b0;
            margin-top: 4px;
        }

        @media (max-width: 800px) {
            .efficiency-readout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="nav-link">‚Üê Back to Cost Curves</a>
        <h1>Spread vs Marketing Trade-off Explorer</h1>
        <p class="subtitle">Maximize contracts while maintaining profitability (Net Profit ‚â• $0)</p>

        <div class="main-grid">
            <div class="controls-panel">
                <div class="constraint-box">
                    <span class="label">Constraint:</span> Net Profit ‚â• $0
                </div>

                <div class="control-section">
                    <div class="control-title"><span class="icon">üìä</span> Input Levers</div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Spread</span>
                            <span class="slider-value" id="spreadValue">11.75%</span>
                        </div>
                        <input type="range" id="spreadSlider" min="900" max="1800" value="1175" step="25">
                        <div class="slider-ticks">
                            <span>9%</span>
                            <span>12%</span>
                            <span>15%</span>
                            <span>18%</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Marketing Spend</span>
                            <span class="slider-value" id="marketingValue">$40M</span>
                        </div>
                        <input type="range" id="marketingSlider" min="0" max="150" value="40" step="5">
                        <div class="slider-ticks">
                            <span>$0</span>
                            <span>$50M</span>
                            <span>$100M</span>
                            <span>$150M</span>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-btn" onclick="setToMaxContracts()">Max Contracts (Profitable)</button>
                        <button class="quick-btn" onclick="setToOptimal()">Optimal Balance</button>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-title"><span class="icon">üéØ</span> Output</div>

                    <div class="output-card primary" id="contractsCard">
                        <div class="output-label">Annual Contracts</div>
                        <div class="output-value large" id="contractsOutput">22,200</div>
                        <span class="status-badge profitable" id="statusBadge">‚úì Profitable</span>
                    </div>

                    <div class="output-grid">
                        <div class="output-card">
                            <div class="output-label">PLP / Contract</div>
                            <div class="output-value" id="plpOutput">$6.4K</div>
                        </div>
                        <div class="output-card">
                            <div class="output-label">Net Profit</div>
                            <div class="output-value" id="netProfitOutput">$102M</div>
                        </div>
                    </div>

                    <div class="output-card">
                        <div class="output-label">Max Profitable Marketing at This Spread</div>
                        <div class="output-value" id="maxMarketingOutput">$142M</div>
                        <div class="output-detail" id="maxMarketingContracts">‚Üí 28,500 contracts at breakeven</div>
                    </div>
                </div>
            </div>

            <div class="chart-panel">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="modeContracts" onclick="setChartMode('contracts')">Contracts View</button>
                    <button class="mode-btn" id="modeEfficiency" onclick="setChartMode('efficiency')">Marginal Efficiency</button>
                </div>

                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>

                <div id="efficiencyPanel" style="display: none; margin-bottom: 24px;">
                    <div class="efficiency-readout">
                        <div class="efficiency-card">
                            <div class="efficiency-label">Contracts per $1M Marketing</div>
                            <div class="efficiency-value" id="contractsPerMillion">‚Äî</div>
                            <div class="efficiency-detail" id="contractsPerMillionDetail">at current spend level</div>
                        </div>
                        <div class="efficiency-card">
                            <div class="efficiency-label">Contracts per 1 bp Spread Reduction</div>
                            <div class="efficiency-value" id="contractsPerBp">‚Äî</div>
                            <div class="efficiency-detail" id="contractsPerBpDetail">at current spread level</div>
                        </div>
                        <div class="efficiency-card highlight">
                            <div class="efficiency-label">Better Lever Right Now</div>
                            <div class="efficiency-value" id="betterLever">‚Äî</div>
                            <div class="efficiency-detail" id="betterLeverDetail">‚Äî</div>
                        </div>
                    </div>
                </div>

                <div class="frontier-section">
                    <div class="frontier-title">Profitability Frontier: Max Contracts by Spread</div>
                    <div class="frontier-description">For each spread level, shows the maximum contracts achievable while maintaining Net Profit ‚â• $0</div>

                    <table class="frontier-table" id="frontierTable">
                        <thead>
                            <tr>
                                <th>Spread</th>
                                <th>PLP/Unit</th>
                                <th>Max Marketing</th>
                                <th>Max Contracts</th>
                                <th>Net Profit</th>
                            </tr>
                        </thead>
                        <tbody id="frontierBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data model
        const spreadLevels = [900, 950, 1000, 1050, 1100, 1139, 1239, 1339, 1439, 1539, 1639, 1739, 1800];
        const spendLevels = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 150];

        const contractsData = {
            900:  [26800, 29700, 31500, 32700, 33900, 35000, 36200, 36800, 37500, 38700, 39300, 40600, 42000],
            950:  [24600, 27200, 28900, 30000, 31100, 32100, 33200, 33800, 34400, 35500, 36100, 37200, 38500],
            1000: [22600, 25000, 26500, 27500, 28500, 29500, 30500, 31000, 31600, 32600, 33100, 34200, 35400],
            1050: [20700, 22900, 24300, 25200, 26200, 27000, 28000, 28400, 29000, 29900, 30400, 31400, 32500],
            1100: [19100, 21100, 22400, 23200, 24100, 24900, 25800, 26200, 26700, 27500, 28000, 28900, 29900],
            1139: [18485, 20581, 21838, 22676, 23514, 24352, 25190, 25609, 26028, 26867, 27286, 28124, 29067],
            1239: [15404, 17151, 18198, 18897, 19595, 20293, 20992, 21341, 21690, 22389, 22738, 23436, 24222],
            1339: [12837, 14292, 15165, 15747, 16329, 16911, 17493, 17784, 18075, 18657, 18948, 19530, 20185],
            1439: [10698, 11910, 12638, 13123, 13608, 14093, 14578, 14820, 15063, 15548, 15790, 16275, 16821],
            1539: [8915, 9925, 10531, 10936, 11340, 11744, 12148, 12350, 12552, 12956, 13159, 13563, 14017],
            1639: [7429, 8271, 8776, 9113, 9450, 9787, 10123, 10292, 10460, 10797, 10965, 11302, 11681],
            1739: [6191, 6892, 7313, 7594, 7875, 8156, 8436, 8577, 8717, 8998, 9138, 9419, 9734],
            1800: [5600, 6200, 6600, 6850, 7100, 7350, 7600, 7730, 7860, 8100, 8230, 8490, 8780]
        };

        // Unit economics
        const baselineSpread = 1175;
        const baselinePLP = 6400;
        const bpsValue = 37.50;

        function calcPLP(spreadBps) {
            return baselinePLP + (spreadBps - baselineSpread) * bpsValue;
        }

        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        function getContracts(spreadBps, marketingM) {
            let lowerSpread = spreadLevels[0];
            let upperSpread = spreadLevels[spreadLevels.length - 1];
            for (let i = 0; i < spreadLevels.length - 1; i++) {
                if (spreadBps >= spreadLevels[i] && spreadBps <= spreadLevels[i + 1]) {
                    lowerSpread = spreadLevels[i];
                    upperSpread = spreadLevels[i + 1];
                    break;
                }
            }

            let lowerSpendIdx = 0;
            let upperSpendIdx = spendLevels.length - 1;
            for (let i = 0; i < spendLevels.length - 1; i++) {
                if (marketingM >= spendLevels[i] && marketingM <= spendLevels[i + 1]) {
                    lowerSpendIdx = i;
                    upperSpendIdx = i + 1;
                    break;
                }
            }

            const tSpread = upperSpread === lowerSpread ? 0 : (spreadBps - lowerSpread) / (upperSpread - lowerSpread);
            const tSpend = spendLevels[upperSpendIdx] === spendLevels[lowerSpendIdx] ? 0 :
                (marketingM - spendLevels[lowerSpendIdx]) / (spendLevels[upperSpendIdx] - spendLevels[lowerSpendIdx]);

            const c00 = contractsData[lowerSpread][lowerSpendIdx];
            const c01 = contractsData[lowerSpread][upperSpendIdx];
            const c10 = contractsData[upperSpread][lowerSpendIdx];
            const c11 = contractsData[upperSpread][upperSpendIdx];

            const c0 = lerp(c00, c01, tSpend);
            const c1 = lerp(c10, c11, tSpend);
            return Math.round(lerp(c0, c1, tSpread));
        }

        function calcNetProfit(spreadBps, marketingM) {
            const contracts = getContracts(spreadBps, marketingM);
            const plp = calcPLP(spreadBps);
            return (contracts * plp) - (marketingM * 1000000);
        }

        // Minimum marketing spend
        const MIN_MARKETING = 0;

        // Find max profitable marketing for a given spread (starting from MIN_MARKETING)
        function findMaxProfitableMarketing(spreadBps) {
            const plp = calcPLP(spreadBps);
            const minContracts = getContracts(spreadBps, MIN_MARKETING);
            const minNetProfit = (minContracts * plp) - (MIN_MARKETING * 1000000);

            // Check if even minimum marketing is unprofitable
            if (minNetProfit < 0) {
                return { marketing: MIN_MARKETING, contracts: minContracts, netProfit: minNetProfit, feasible: false };
            }

            let maxMarketing = MIN_MARKETING;
            let maxContracts = minContracts;

            for (let m = MIN_MARKETING; m <= 200; m += 1) {
                const contracts = getContracts(spreadBps, m);
                const netProfit = (contracts * plp) - (m * 1000000);
                if (netProfit >= 0) {
                    maxMarketing = m;
                    maxContracts = contracts;
                } else {
                    break;
                }
            }

            return {
                marketing: maxMarketing,
                contracts: maxContracts,
                netProfit: (maxContracts * plp) - (maxMarketing * 1000000),
                feasible: true
            };
        }

        // State
        let currentSpread = 1175;
        let currentMarketing = 40;
        let chart = null;
        let chartMode = 'contracts';

        // Calculate marginal contracts per $1M marketing (at current spread)
        function calcContractsPerMillion(spreadBps, marketingM) {
            const delta = 1; // $1M increment
            const contractsNow = getContracts(spreadBps, marketingM);
            const contractsNext = getContracts(spreadBps, marketingM + delta);
            return contractsNext - contractsNow;
        }

        // Calculate marginal contracts per 1bp spread reduction (at current marketing)
        function calcContractsPerBp(spreadBps, marketingM) {
            const delta = 1; // 1 bp reduction
            const contractsNow = getContracts(spreadBps, marketingM);
            const contractsLower = getContracts(spreadBps - delta, marketingM);
            return contractsLower - contractsNow;
        }

        function formatMoney(value) {
            const absValue = Math.abs(value);
            if (absValue >= 1000000000) {
                return (value < 0 ? '-' : '') + '$' + (absValue / 1000000000).toFixed(1) + 'B';
            }
            return (value < 0 ? '-' : '') + '$' + Math.round(absValue / 1000000) + 'M';
        }

        function updateOutputs() {
            const contracts = getContracts(currentSpread, currentMarketing);
            const plp = calcPLP(currentSpread);
            const grossProfit = contracts * plp;
            const netProfit = grossProfit - (currentMarketing * 1000000);
            const isProfitable = netProfit >= 0;

            // Update sliders display
            document.getElementById('spreadValue').textContent = (currentSpread / 100).toFixed(2) + '%';
            document.getElementById('marketingValue').textContent = '$' + currentMarketing + 'M';

            // Main output
            document.getElementById('contractsOutput').textContent = contracts.toLocaleString();

            const contractsCard = document.getElementById('contractsCard');
            const statusBadge = document.getElementById('statusBadge');
            if (isProfitable) {
                contractsCard.className = 'output-card primary';
                statusBadge.className = 'status-badge profitable';
                statusBadge.textContent = '‚úì Profitable';
            } else {
                contractsCard.className = 'output-card danger';
                statusBadge.className = 'status-badge unprofitable';
                statusBadge.textContent = '‚úó Unprofitable';
            }

            // PLP
            const plpK = plp / 1000;
            document.getElementById('plpOutput').textContent = plp >= 0 ? '$' + plpK.toFixed(1) + 'K' : '-$' + Math.abs(plpK).toFixed(1) + 'K';
            document.getElementById('plpOutput').style.color = plp < 0 ? '#f87171' : plp < 3000 ? '#facc15' : '#4ade80';

            // Net profit
            document.getElementById('netProfitOutput').textContent = formatMoney(netProfit);
            document.getElementById('netProfitOutput').style.color = netProfit < 0 ? '#f87171' : '#4ade80';

            // Max marketing at this spread
            const maxInfo = findMaxProfitableMarketing(currentSpread);
            document.getElementById('maxMarketingOutput').textContent = '$' + maxInfo.marketing + 'M';
            document.getElementById('maxMarketingContracts').textContent = `‚Üí ${maxInfo.contracts.toLocaleString()} contracts at breakeven`;

            updateChart();
            updateFrontierTable();
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: '#8892b0' } },
                        tooltip: {
                            backgroundColor: 'rgba(20, 20, 35, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#e8e8e8',
                            callbacks: {
                                label: function(ctx) {
                                    const spread = ctx.dataset.spread;
                                    const marketing = ctx.parsed.x;
                                    const contracts = ctx.parsed.y;
                                    const netProfit = calcNetProfit(spread, marketing);
                                    return `${contracts.toLocaleString()} contracts (Net: ${formatMoney(netProfit)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Marketing Spend ($M)', color: '#8892b0' },
                            ticks: { color: '#8892b0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            min: 0,
                            max: 160
                        },
                        y: {
                            title: { display: true, text: 'Contracts', color: '#8892b0' },
                            ticks: { color: '#8892b0', callback: v => v.toLocaleString() },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });
            updateChart();
        }

        function setChartMode(mode) {
            chartMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');

            document.getElementById('efficiencyPanel').style.display = mode === 'efficiency' ? 'block' : 'none';

            updateChart();
        }

        function updateChart() {
            if (!chart) return;

            if (chartMode === 'efficiency') {
                updateEfficiencyChart();
                return;
            }

            const datasets = [];
            const displaySpreads = [1000, 1100, 1200, 1300, 1400, 1500, 1600];
            const colors = ['#06b6d4', '#10b981', '#84cc16', '#eab308', '#f97316', '#ef4444', '#991b1b'];

            displaySpreads.forEach((spread, i) => {
                const plp = calcPLP(spread);
                const maxInfo = findMaxProfitableMarketing(spread);

                // Profitable region (solid)
                const profitableData = [];
                const startM = Math.max(MIN_MARKETING, 10);
                for (let m = startM; m <= maxInfo.marketing; m += 5) {
                    profitableData.push({ x: m, y: getContracts(spread, m) });
                }
                if (maxInfo.marketing % 5 !== 0 && maxInfo.marketing > startM) {
                    profitableData.push({ x: maxInfo.marketing, y: maxInfo.contracts });
                }

                datasets.push({
                    label: `${(spread/100).toFixed(0)}% (PLP: $${(plp/1000).toFixed(1)}K)`,
                    data: profitableData,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '20',
                    borderWidth: Math.abs(spread - currentSpread) < 50 ? 3 : 1.5,
                    pointRadius: 0,
                    fill: false,
                    spread: spread
                });

                // Unprofitable region (dashed)
                if (maxInfo.marketing < 150) {
                    const unprofitableData = [];
                    for (let m = maxInfo.marketing; m <= 150; m += 5) {
                        unprofitableData.push({ x: m, y: getContracts(spread, m) });
                    }
                    datasets.push({
                        label: '',
                        data: unprofitableData,
                        borderColor: colors[i] + '40',
                        borderWidth: 1,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        spread: spread
                    });
                }

                // Max point marker
                datasets.push({
                    label: '',
                    data: [{ x: maxInfo.marketing, y: maxInfo.contracts }],
                    backgroundColor: colors[i],
                    borderColor: '#fff',
                    borderWidth: 2,
                    pointRadius: 6,
                    showLine: false,
                    spread: spread
                });
            });

            // Current selection
            const currentContracts = getContracts(currentSpread, currentMarketing);
            const currentNetProfit = calcNetProfit(currentSpread, currentMarketing);
            datasets.push({
                label: 'Current',
                data: [{ x: currentMarketing, y: currentContracts }],
                backgroundColor: currentNetProfit >= 0 ? '#22c55e' : '#f87171',
                borderColor: '#fff',
                borderWidth: 3,
                pointRadius: 12,
                pointStyle: 'circle',
                showLine: false,
                spread: currentSpread
            });

            chart.data.datasets = datasets;

            // Reset scales for contracts view
            chart.options.scales = {
                x: {
                    type: 'linear',
                    title: { display: true, text: 'Marketing Spend ($M)', color: '#8892b0' },
                    ticks: { color: '#8892b0' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    min: 0,
                    max: 160
                },
                y: {
                    type: 'linear',
                    title: { display: true, text: 'Contracts', color: '#8892b0' },
                    ticks: { color: '#8892b0', callback: v => v.toLocaleString() },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                }
            };

            chart.update();
        }

        function updateFrontierTable() {
            const tbody = document.getElementById('frontierBody');
            tbody.innerHTML = '';

            const displaySpreads = [900, 950, 1000, 1050, 1100, 1150, 1200, 1250, 1300, 1400, 1500, 1600, 1700];
            let maxContracts = 0;
            let maxContractsSpread = 0;

            // First pass: find max
            displaySpreads.forEach(spread => {
                const info = findMaxProfitableMarketing(spread);
                if (info.feasible && info.contracts > maxContracts) {
                    maxContracts = info.contracts;
                    maxContractsSpread = spread;
                }
            });

            displaySpreads.forEach(spread => {
                const plp = calcPLP(spread);
                const info = findMaxProfitableMarketing(spread);
                const isSelected = Math.abs(spread - currentSpread) < 30;
                const isMax = spread === maxContractsSpread;
                const isInfeasible = !info.feasible;

                const plpDisplay = plp >= 0 ? '$' + (plp/1000).toFixed(1) + 'K' : '-$' + (Math.abs(plp)/1000).toFixed(1) + 'K';

                let rowClass = '';
                if (isSelected) rowClass = 'selected';
                else if (isInfeasible) rowClass = 'infeasible';

                tbody.innerHTML += `
                    <tr class="${rowClass}" onclick="setSpread(${spread})" style="cursor: pointer;">
                        <td>${(spread/100).toFixed(2)}%${spread < 1100 ? ' *' : ''}</td>
                        <td style="color: ${plp < 0 ? '#f87171' : plp < 3000 ? '#facc15' : '#4ade80'}">${plpDisplay}</td>
                        <td>${isInfeasible ? '‚Äî' : '$' + info.marketing + 'M'}</td>
                        <td class="${isMax && !isInfeasible ? 'max-contracts' : ''}">${isInfeasible ? '‚Äî' : info.contracts.toLocaleString()}${isMax && !isInfeasible ? ' ‚úì' : ''}</td>
                        <td>${isInfeasible ? '‚Äî' : formatMoney(info.netProfit)}</td>
                    </tr>
                `;
            });
        }

        function setSpread(spread) {
            currentSpread = spread;
            document.getElementById('spreadSlider').value = spread;

            // Also set marketing to max profitable for this spread
            const maxInfo = findMaxProfitableMarketing(spread);
            currentMarketing = Math.min(maxInfo.marketing, 150);
            document.getElementById('marketingSlider').value = currentMarketing;

            updateOutputs();
        }

        function setToMaxContracts() {
            // Find spread with max profitable contracts
            let maxContracts = 0;
            let bestSpread = 1175;
            let bestMarketing = 40;

            for (let spread = 1000; spread <= 1700; spread += 25) {
                const plp = calcPLP(spread);
                if (plp > 0) {
                    const info = findMaxProfitableMarketing(spread);
                    if (info.contracts > maxContracts) {
                        maxContracts = info.contracts;
                        bestSpread = spread;
                        bestMarketing = info.marketing;
                    }
                }
            }

            currentSpread = bestSpread;
            currentMarketing = Math.min(bestMarketing, 150);
            document.getElementById('spreadSlider').value = currentSpread;
            document.getElementById('marketingSlider').value = currentMarketing;
            updateOutputs();
        }

        function setToOptimal() {
            // Balance: good contracts with healthy profit margin
            currentSpread = 1300;
            currentMarketing = 50;
            document.getElementById('spreadSlider').value = currentSpread;
            document.getElementById('marketingSlider').value = currentMarketing;
            updateOutputs();
        }

        function updateEfficiencyChart() {
            const datasets = [];

            // Contracts per $1M marketing (blue) - varies by marketing spend
            const marketingEfficiencyData = [];
            for (let m = 0; m <= 150; m += 5) {
                const efficiency = calcContractsPerMillion(currentSpread, m);
                marketingEfficiencyData.push({ x: m, y: efficiency });
            }
            datasets.push({
                label: 'Contracts per $1M Marketing',
                data: marketingEfficiencyData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                yAxisID: 'y'
            });

            // Contracts per 1bp spread reduction (orange) - varies by spread
            const spreadEfficiencyData = [];
            for (let s = 900; s <= 1700; s += 25) {
                const efficiency = calcContractsPerBp(s, currentMarketing);
                // Map spread to equivalent x position for overlay (scale 900-1700 to 0-150)
                const xPos = (s - 900) / (1700 - 900) * 150;
                spreadEfficiencyData.push({ x: xPos, y: efficiency, spread: s });
            }
            datasets.push({
                label: 'Contracts per 1bp Spread Reduction',
                data: spreadEfficiencyData,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                yAxisID: 'y2'
            });

            // Current position marker for marketing
            const currentMarketingEff = calcContractsPerMillion(currentSpread, currentMarketing);
            datasets.push({
                label: 'Current Marketing',
                data: [{ x: currentMarketing, y: currentMarketingEff }],
                backgroundColor: '#3b82f6',
                borderColor: '#fff',
                borderWidth: 2,
                pointRadius: 10,
                showLine: false,
                yAxisID: 'y'
            });

            // Current position marker for spread
            const currentSpreadEff = calcContractsPerBp(currentSpread, currentMarketing);
            const currentSpreadX = (currentSpread - 900) / (1700 - 900) * 150;
            datasets.push({
                label: 'Current Spread',
                data: [{ x: currentSpreadX, y: currentSpreadEff }],
                backgroundColor: '#f59e0b',
                borderColor: '#fff',
                borderWidth: 2,
                pointRadius: 10,
                showLine: false,
                yAxisID: 'y2'
            });

            chart.data.datasets = datasets;

            // Update scales for dual axis
            chart.options.scales = {
                x: {
                    type: 'linear',
                    title: { display: true, text: 'Marketing ($M) / Spread (mapped 9%-17%)', color: '#8892b0' },
                    ticks: {
                        color: '#8892b0',
                        callback: function(value) {
                            // Show both scales
                            const spread = 900 + (value / 150) * 800;
                            return `$${value}M | ${(spread/100).toFixed(1)}%`;
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    min: 0,
                    max: 150
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Contracts per $1M', color: '#3b82f6' },
                    ticks: { color: '#3b82f6' },
                    grid: { color: 'rgba(59, 130, 246, 0.1)' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Contracts per 1bp', color: '#f59e0b' },
                    ticks: { color: '#f59e0b' },
                    grid: { display: false }
                }
            };

            chart.update();

            // Update efficiency readout
            document.getElementById('contractsPerMillion').textContent = currentMarketingEff.toFixed(0);
            document.getElementById('contractsPerMillion').className = 'efficiency-value marketing';
            document.getElementById('contractsPerMillionDetail').textContent = `at $${currentMarketing}M spend, ${(currentSpread/100).toFixed(2)}% spread`;

            document.getElementById('contractsPerBp').textContent = currentSpreadEff.toFixed(1);
            document.getElementById('contractsPerBp').className = 'efficiency-value spread';
            document.getElementById('contractsPerBpDetail').textContent = `at ${(currentSpread/100).toFixed(2)}% spread, $${currentMarketing}M spend`;

            // Compare: which is better?
            // To compare fairly: what's the $ cost of 1bp spread reduction?
            // 1bp = $37.50 per contract. At current contracts, that's: contracts √ó $37.50
            const currentContracts = getContracts(currentSpread, currentMarketing);
            const costOf1bp = currentContracts * 37.50; // annual margin cost
            const contractsFromSpread = currentSpreadEff;
            const costPerContractFromSpread = contractsFromSpread > 0 ? costOf1bp / contractsFromSpread : Infinity;

            // Marketing: $1M gets currentMarketingEff contracts
            const costPerContractFromMarketing = currentMarketingEff > 0 ? 1000000 / currentMarketingEff : Infinity;

            const betterLeverEl = document.getElementById('betterLever');
            const betterLeverDetailEl = document.getElementById('betterLeverDetail');

            if (costPerContractFromMarketing < costPerContractFromSpread) {
                betterLeverEl.textContent = 'Marketing';
                betterLeverEl.className = 'efficiency-value marketing';
                betterLeverDetailEl.textContent = `$${(costPerContractFromMarketing/1000).toFixed(1)}K/contract vs $${(costPerContractFromSpread/1000).toFixed(1)}K from spread`;
            } else {
                betterLeverEl.textContent = 'Spread';
                betterLeverEl.className = 'efficiency-value spread';
                betterLeverDetailEl.textContent = `$${(costPerContractFromSpread/1000).toFixed(1)}K/contract vs $${(costPerContractFromMarketing/1000).toFixed(1)}K from marketing`;
            }
        }

        // Event listeners
        document.getElementById('spreadSlider').addEventListener('input', function() {
            currentSpread = parseInt(this.value);
            updateOutputs();
        });

        document.getElementById('marketingSlider').addEventListener('input', function() {
            currentMarketing = parseInt(this.value);
            updateOutputs();
        });

        // Initialize
        initChart();
        updateOutputs();
    </script>
</body>
</html>
