<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Spend vs Contracts - Diminishing Returns Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .subtitle {
            color: #8892b0;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: #fff;
        }

        .chart-description {
            font-size: 13px;
            color: #8892b0;
            margin-top: 4px;
        }

        .legend-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .legend-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-btn .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-btn.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-btn:not(.active) {
            opacity: 0.4;
        }

        .legend-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            opacity: 1;
        }

        .chart-container {
            position: relative;
            height: 450px;
        }

        .table-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            margin-bottom: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 4px;
        }

        .table-description {
            font-size: 13px;
            color: #8892b0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #fff;
            position: sticky;
            top: 0;
        }

        th:first-child, td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: #1a1a2e;
            z-index: 1;
        }

        th:first-child {
            z-index: 2;
            background: rgba(30, 30, 50, 1);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        tr:hover td:first-child {
            background: rgba(40, 40, 60, 1);
        }

        .mcac-low {
            color: #4ade80;
        }

        .mcac-med {
            color: #facc15;
        }

        .mcac-high {
            color: #f87171;
        }

        .spread-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spread-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .insights-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
        }

        .insight-label {
            font-size: 12px;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
        }

        .insight-detail {
            font-size: 13px;
            color: #8892b0;
            margin-top: 4px;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-label {
            font-size: 12px;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            padding: 10px 14px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            width: 160px;
        }

        .control-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .toggle-group {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
        }

        .toggle-btn {
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: #8892b0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Dev Mode Styles */
        .dev-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            margin-top: 24px;
            overflow: hidden;
        }

        .dev-header {
            background: rgba(34, 197, 94, 0.1);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
            font-size: 14px;
            color: #22c55e;
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
        }

        .dev-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .dev-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dev-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .dev-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 12px;
            font-family: monospace;
        }

        .dev-section pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            overflow-x: auto;
            color: #a5b4fc;
            font-family: 'Monaco', 'Menlo', monospace;
            line-height: 1.5;
        }

        .dev-formula {
            background: rgba(0, 0, 0, 0.2);
            padding: 16px;
            border-radius: 6px;
            font-size: 13px;
        }

        .dev-formula code {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .dev-formula p {
            margin-bottom: 8px;
            color: #c4c4c4;
        }

        .dev-formula ol {
            margin-left: 20px;
            color: #c4c4c4;
        }

        .dev-formula ol li {
            margin-bottom: 4px;
        }

        .dev-note {
            font-size: 12px;
            color: #8892b0;
            font-style: italic;
            margin-top: 8px;
        }

        #devModeBtn.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Marketing Cost Curves: Diminishing Returns Analysis</h1>
        <p class="subtitle">GTM Model sensitivity table - Contracts by spread level and marketing spend</p>

        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">Average Home Price</label>
                <input type="text" class="control-input" id="avgHomePrice" value="$375,000" />
            </div>
            <div class="control-group">
                <label class="control-label">Display Mode</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="toggleDollar" onclick="setDisplayMode('dollar')">$ Amount</button>
                    <button class="toggle-btn" id="togglePercent" onclick="setDisplayMode('percent')">% of Home Price</button>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Add Custom Spread (%)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="control-input" id="customSpread" placeholder="e.g. 11.27" style="width: 100px;" />
                    <button class="toggle-btn" onclick="addCustomSpread()" style="background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #22c55e;">Add Curve</button>
                </div>
            </div>
            <div class="control-group" id="customSpreadsList" style="display: none;">
                <label class="control-label">Custom Spreads</label>
                <div id="customSpreadsChips" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
            <div class="control-group" style="margin-left: auto;">
                <label class="control-label">Debug</label>
                <button class="toggle-btn" id="devModeBtn" onclick="toggleDevMode()" style="font-family: monospace;">üîß .dev</button>
            </div>
        </div>

        <div class="insights-section">
            <div class="insight-card">
                <div class="insight-label">Contracts at 11.39% spread, $40M</div>
                <div class="insight-value">23,514</div>
                <div class="insight-detail">lowest spread level in model</div>
            </div>
            <div class="insight-card">
                <div class="insight-label">mCAC Range at 11.39% Spread</div>
                <div class="insight-value">$4.8K - $53K</div>
                <div class="insight-detail">per incremental contract ($0-5M to $145-150M)</div>
            </div>
            <div class="insight-card">
                <div class="insight-label">Max Contracts (11.39% spread, $150M)</div>
                <div class="insight-value">29,067</div>
                <div class="insight-detail">vs 9,734 at 17.39% spread</div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Contracts by Marketing Spend</div>
                    <div class="chart-description">Click legend items to show/hide curves. Lower spreads (green) = higher conversion. Your current ~11.27% spread is closest to the 11.39% curve.</div>
                </div>
                <div class="legend-toggles" id="legendToggles"></div>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <div>
                    <div class="table-title">Marginal CAC by $5M Tranche</div>
                    <div class="table-description">Cost per incremental contract at each spend level. <span class="mcac-low">Green</span> = ‚â§2% of home price, <span class="mcac-med">Yellow</span> = 2-4%, <span class="mcac-high">Red</span> = &gt;4%</div>
                </div>
            </div>
            <table id="mcacTable"></table>
        </div>

        <div class="table-section">
            <div class="table-header">
                <div>
                    <div class="table-title">Incremental CAC (Cumulative)</div>
                    <div class="table-description">Average cost per contract for all spend up to that level. Same color scale: <span class="mcac-low">‚â§2%</span>, <span class="mcac-med">2-4%</span>, <span class="mcac-high">&gt;4%</span> of home price</div>
                </div>
            </div>
            <table id="icacTable"></table>
        </div>
    </div>

        <!-- Dev Mode Panel -->
        <div class="dev-panel" id="devPanel" style="display: none;">
            <div class="dev-header">
                <span>üîß Developer Mode - Data & Computation Details</span>
                <button onclick="toggleDevMode()" style="background:none;border:none;color:#8892b0;cursor:pointer;font-size:18px;">√ó</button>
            </div>
            <div class="dev-content">
                <div class="dev-section">
                    <h3>üìä Raw Data Source</h3>
                    <p class="dev-note">Data extracted from: <code>GTM (Growth Toy Model).xlsx</code> ‚Üí Sheet: <code>Sensitivity Tables (Base 2026)</code></p>
                    <pre id="rawDataTable"></pre>
                </div>

                <div class="dev-section">
                    <h3>üìê Interpolation Method</h3>
                    <div class="dev-formula">
                        <p><strong>Cubic Spline Interpolation</strong> - Natural cubic spline with second derivative = 0 at endpoints</p>
                        <p>For each interval [x·µ¢, x·µ¢‚Çä‚ÇÅ], the spline is:</p>
                        <code>S(x) = a·µ¢ + b·µ¢(x - x·µ¢) + c·µ¢(x - x·µ¢)¬≤ + d·µ¢(x - x·µ¢)¬≥</code>
                        <p style="margin-top: 12px;"><strong>2D Interpolation for Custom Spreads:</strong></p>
                        <ol>
                            <li>For each spend level, interpolate contracts across spread dimension</li>
                            <li>Use resulting values to build the full curve</li>
                        </ol>
                    </div>
                </div>

                <div class="dev-section">
                    <h3>üí∞ CAC Formulas</h3>
                    <div class="dev-formula">
                        <p><strong>Marginal CAC (mCAC)</strong> - Cost per incremental contract in each $5M tranche:</p>
                        <code>mCAC = $5,000,000 / (contracts[spend + $5M] - contracts[spend])</code>

                        <p style="margin-top: 16px;"><strong>Incremental CAC (iCAC)</strong> - Blended cost for all marketing-driven contracts:</p>
                        <code>iCAC = total_spend / (contracts[spend] - contracts[$0])</code>
                        <p class="dev-note">Note: contracts[$0] represents organic/baseline contracts with zero marketing spend</p>
                    </div>
                </div>

                <div class="dev-section">
                    <h3>üé® Color Thresholds</h3>
                    <div class="dev-formula">
                        <code>efficient (green): CAC ‚â§ 2.0% √ó avgHomePrice</code><br>
                        <code>moderate (yellow): CAC ‚â§ 4.0% √ó avgHomePrice</code><br>
                        <code>expensive (red):   CAC > 4.0% √ó avgHomePrice</code>
                        <p class="dev-note" id="thresholdCalc"></p>
                    </div>
                </div>

                <div class="dev-section">
                    <h3>üî¢ Interpolated Data (at $5M intervals)</h3>
                    <pre id="interpolatedDataTable"></pre>
                </div>

                <div class="dev-section" id="customSpreadDebug" style="display: none;">
                    <h3>‚≠ê Custom Spread Calculations</h3>
                    <div id="customSpreadCalcs"></div>
                </div>

                <div class="dev-section">
                    <h3>üìà Sample mCAC Calculation</h3>
                    <div id="sampleCalc"></div>
                </div>
            </div>
        </div>

    <script>
        // Raw data from GTM sensitivity table (Base 2026)
        const spreadLevels = [1139, 1239, 1339, 1439, 1539, 1639, 1739]; // basis points
        const spendLevelsRaw = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 150]; // millions

        // Contracts matrix [spend][spread] from GTM table
        const contractsRaw = {
            0:   [18485, 15404, 12837, 10698, 8915, 7429, 6191],
            10:  [20581, 17151, 14292, 11910, 9925, 8271, 6892],
            20:  [21838, 18198, 15165, 12638, 10531, 8776, 7313],
            30:  [22676, 18897, 15747, 13123, 10936, 9113, 7594],
            40:  [23514, 19595, 16329, 13608, 11340, 9450, 7875],
            50:  [24352, 20293, 16911, 14093, 11744, 9787, 8156],
            60:  [25190, 20992, 17493, 14578, 12148, 10123, 8436],
            70:  [25609, 21341, 17784, 14820, 12350, 10292, 8577],
            80:  [26028, 21690, 18075, 15063, 12552, 10460, 8717],
            90:  [26867, 22389, 18657, 15548, 12956, 10797, 8998],
            100: [27286, 22738, 18948, 15790, 13159, 10965, 9138],
            120: [28124, 23436, 19530, 16275, 13563, 11302, 9419],
            150: [29067, 24222, 20185, 16821, 14017, 11681, 9734]
        };

        // State
        let displayMode = 'dollar';
        let avgHomePrice = 375000;

        // Cubic spline interpolation
        function cubicSpline(x, y) {
            const n = x.length;
            const h = [], alpha = [], l = [1], mu = [0], z = [0];
            const c = new Array(n).fill(0);
            const b = new Array(n - 1);
            const d = new Array(n - 1);

            for (let i = 0; i < n - 1; i++) {
                h[i] = x[i + 1] - x[i];
            }

            for (let i = 1; i < n - 1; i++) {
                alpha[i] = (3 / h[i]) * (y[i + 1] - y[i]) - (3 / h[i - 1]) * (y[i] - y[i - 1]);
            }

            for (let i = 1; i < n - 1; i++) {
                l[i] = 2 * (x[i + 1] - x[i - 1]) - h[i - 1] * mu[i - 1];
                mu[i] = h[i] / l[i];
                z[i] = (alpha[i] - h[i - 1] * z[i - 1]) / l[i];
            }

            l[n - 1] = 1;
            z[n - 1] = 0;

            for (let j = n - 2; j >= 0; j--) {
                c[j] = z[j] - mu[j] * c[j + 1];
                b[j] = (y[j + 1] - y[j]) / h[j] - h[j] * (c[j + 1] + 2 * c[j]) / 3;
                d[j] = (c[j + 1] - c[j]) / (3 * h[j]);
            }

            return function(xVal) {
                let i = 0;
                for (let j = 0; j < n - 1; j++) {
                    if (xVal >= x[j] && xVal <= x[j + 1]) {
                        i = j;
                        break;
                    }
                    if (xVal > x[n - 2]) i = n - 2;
                }
                const dx = xVal - x[i];
                return y[i] + b[i] * dx + c[i] * dx * dx + d[i] * dx * dx * dx;
            };
        }

        // Interpolate to $5M intervals
        const spendLevels5M = [];
        for (let s = 0; s <= 150; s += 5) {
            spendLevels5M.push(s);
        }

        // Build interpolated data for each spread level
        const interpolatedData = {};
        spreadLevels.forEach((spread, spreadIdx) => {
            const xVals = spendLevelsRaw;
            const yVals = spendLevelsRaw.map(s => contractsRaw[s][spreadIdx]);
            const spline = cubicSpline(xVals, yVals);
            interpolatedData[spread] = spendLevels5M.map(s => Math.round(spline(s)));
        });

        // Calculate mCAC for each $5M tranche
        function calcMCAC(contracts, spendIdx) {
            if (spendIdx === 0) return null;
            const deltaContracts = contracts[spendIdx] - contracts[spendIdx - 1];
            if (deltaContracts <= 0) return Infinity;
            return 5000000 / deltaContracts;
        }

        // Calculate incremental CAC (cumulative from $0)
        function calcICAC(contracts, spendIdx, baseContracts) {
            if (spendIdx === 0) return null;
            const totalSpend = spendLevels5M[spendIdx] * 1000000;
            const totalIncrementalContracts = contracts[spendIdx] - baseContracts;
            if (totalIncrementalContracts <= 0) return Infinity;
            return totalSpend / totalIncrementalContracts;
        }

        // Colors for spread levels (from green to red)
        const colors = [
            '#22c55e', // 1139 - greenest (best conversion)
            '#84cc16', // 1239
            '#eab308', // 1339
            '#f97316', // 1439
            '#ef4444', // 1539
            '#dc2626', // 1639 - current
            '#991b1b'  // 1739
        ];

        // Chart.js setup
        const ctx = document.getElementById('mainChart').getContext('2d');

        const datasets = spreadLevels.map((spread, idx) => ({
            label: `${(spread / 100).toFixed(2)}% spread`,
            data: spendLevels5M.map((s, i) => ({
                x: s,
                y: interpolatedData[spread][i]
            })),
            borderColor: colors[idx],
            backgroundColor: colors[idx] + '20',
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 6,
            tension: 0.4,
            hidden: false
        }));

        const chart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(20, 20, 35, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#e8e8e8',
                        borderColor: 'rgba(255, 255, 255, 0.15)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            title: (items) => `$${items[0].parsed.x}M Marketing Spend`,
                            label: (item) => {
                                const contracts = item.parsed.y.toLocaleString();
                                const spread = spreadLevels[item.datasetIndex];
                                const spendIdx = spendLevels5M.indexOf(item.parsed.x);
                                const mcac = calcMCAC(interpolatedData[spread], spendIdx);
                                let mcacStr = mcac === null ? 'N/A' :
                                              mcac === Infinity ? '‚àû' :
                                              '$' + Math.round(mcac).toLocaleString();
                                return `${(spread/100).toFixed(2)}%: ${contracts} contracts (mCAC: ${mcacStr})`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Marketing Spend ($M)',
                            color: '#8892b0'
                        },
                        ticks: {
                            color: '#8892b0',
                            callback: (val) => '$' + val + 'M'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Contracts',
                            color: '#8892b0'
                        },
                        ticks: {
                            color: '#8892b0',
                            callback: (val) => val.toLocaleString()
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    }
                }
            }
        });

        // Create legend toggles
        const legendContainer = document.getElementById('legendToggles');
        const legendButtons = [];
        spreadLevels.forEach((spread, idx) => {
            const btn = document.createElement('button');
            btn.className = 'legend-btn active';
            btn.style.borderColor = colors[idx];
            btn.style.color = colors[idx];
            btn.innerHTML = `<span class="dot" style="background: ${colors[idx]}"></span>${(spread/100).toFixed(2)}%`;
            btn.addEventListener('click', function() {
                const meta = chart.getDatasetMeta(idx);
                meta.hidden = meta.hidden === null ? true : !meta.hidden;
                btn.classList.toggle('active', !meta.hidden);
                chart.update();
            });
            legendButtons.push(btn);
            legendContainer.appendChild(btn);
        });

        // Color thresholds based on % of home price
        // Efficient: <= 2.0%, Moderate: 2.0% - 4.0%, Expensive: > 4.0%
        const efficientPct = 2.0;
        const moderatePct = 4.0;

        // Format value based on display mode
        function formatValue(dollarValue) {
            if (dollarValue === null) return { display: '‚Äî', colorClass: '' };
            if (dollarValue === Infinity || dollarValue > 500000) {
                return { display: displayMode === 'dollar' ? '>$500K' : '>100%', colorClass: 'mcac-high' };
            }

            let display, colorClass;
            const pctOfHome = (dollarValue / avgHomePrice) * 100;

            if (displayMode === 'dollar') {
                display = '$' + Math.round(dollarValue / 1000) + 'K';
            } else {
                display = pctOfHome.toFixed(1) + '%';
            }

            // Color based on % of home price thresholds
            if (pctOfHome <= efficientPct) colorClass = 'mcac-low';
            else if (pctOfHome <= moderatePct) colorClass = 'mcac-med';
            else colorClass = 'mcac-high';

            return { display, colorClass };
        }

        // Build tables
        function buildTables() {
            
            // mCAC Table
            const mcacTableEl = document.getElementById('mcacTable');
            let mcacHeaderHtml = '<thead><tr><th>Spread</th>';
            for (let i = 1; i < spendLevels5M.length; i++) {
                mcacHeaderHtml += `<th>$${spendLevels5M[i-1]}-${spendLevels5M[i]}M</th>`;
            }
            mcacHeaderHtml += '</tr></thead>';

            let mcacBodyHtml = '<tbody>';
            spreadLevels.forEach((spread, spreadIdx) => {
                mcacBodyHtml += `<tr><td><span class="spread-label"><span class="spread-dot" style="background: ${colors[spreadIdx]}"></span>${(spread/100).toFixed(2)}%</span></td>`;

                const contracts = interpolatedData[spread];
                for (let i = 1; i < spendLevels5M.length; i++) {
                    const mcac = calcMCAC(contracts, i);
                    const { display, colorClass } = formatValue(mcac);
                    mcacBodyHtml += `<td class="${colorClass}">${display}</td>`;
                }
                mcacBodyHtml += '</tr>';
            });
            mcacBodyHtml += '</tbody>';
            mcacTableEl.innerHTML = mcacHeaderHtml + mcacBodyHtml;

            // iCAC Table
            const icacTableEl = document.getElementById('icacTable');
            let icacHeaderHtml = '<thead><tr><th>Spread</th>';
            for (let i = 1; i < spendLevels5M.length; i++) {
                icacHeaderHtml += `<th>$${spendLevels5M[i]}M</th>`;
            }
            icacHeaderHtml += '</tr></thead>';

            let icacBodyHtml = '<tbody>';
            spreadLevels.forEach((spread, spreadIdx) => {
                icacBodyHtml += `<tr><td><span class="spread-label"><span class="spread-dot" style="background: ${colors[spreadIdx]}"></span>${(spread/100).toFixed(2)}%</span></td>`;

                const contracts = interpolatedData[spread];
                const baseContracts = contracts[0]; // contracts at $0 spend
                for (let i = 1; i < spendLevels5M.length; i++) {
                    const icac = calcICAC(contracts, i, baseContracts);
                    const { display, colorClass } = formatValue(icac);
                    icacBodyHtml += `<td class="${colorClass}">${display}</td>`;
                }
                icacBodyHtml += '</tr>';
            });
            icacBodyHtml += '</tbody>';
            icacTableEl.innerHTML = icacHeaderHtml + icacBodyHtml;
        }

        // Display mode toggle
        function setDisplayMode(mode) {
            displayMode = mode;
            document.getElementById('toggleDollar').classList.toggle('active', mode === 'dollar');
            document.getElementById('togglePercent').classList.toggle('active', mode === 'percent');
            buildTables();
        }

        // Average home price input
        document.getElementById('avgHomePrice').addEventListener('change', function(e) {
            const val = e.target.value.replace(/[^0-9]/g, '');
            avgHomePrice = parseInt(val) || 375000;
            e.target.value = '$' + avgHomePrice.toLocaleString();
            buildTables();
        });

        document.getElementById('avgHomePrice').addEventListener('focus', function(e) {
            e.target.select();
        });

        // Initial table build
        buildTables();

        // Custom spread management
        const customSpreads = [];

        // Interpolate contracts for a custom spread at a given spend index
        function interpolateAtSpread(customSpreadBps, spendIdx) {
            // Get contracts at this spend index for all spread levels
            const spreadValues = spreadLevels;
            const contractValues = spreadLevels.map(s => interpolatedData[s][spendIdx]);

            // Use cubic spline to interpolate across spread dimension
            const spline = cubicSpline(spreadValues, contractValues);
            return Math.round(spline(customSpreadBps));
        }

        // Generate full curve data for a custom spread
        function generateCustomCurveData(customSpreadBps) {
            return spendLevels5M.map((spend, idx) => ({
                x: spend,
                y: interpolateAtSpread(customSpreadBps, idx)
            }));
        }

        // Generate color for custom spread (interpolate between existing colors)
        function getColorForSpread(spreadBps) {
            // Find where this spread falls in our range
            const minSpread = spreadLevels[0];
            const maxSpread = spreadLevels[spreadLevels.length - 1];
            const t = (spreadBps - minSpread) / (maxSpread - minSpread);

            // Interpolate hue from green (120) to red (0)
            const hue = 120 - (t * 120);
            return `hsl(${Math.round(hue)}, 70%, 50%)`;
        }

        function addCustomSpread() {
            const input = document.getElementById('customSpread');
            const value = parseFloat(input.value);

            if (isNaN(value) || value < 10 || value > 20) {
                alert('Please enter a spread between 10% and 20%');
                return;
            }

            const spreadBps = Math.round(value * 100); // Convert to basis points

            // Check if already exists
            if (customSpreads.includes(spreadBps) || spreadLevels.includes(spreadBps)) {
                alert('This spread level already exists');
                return;
            }

            customSpreads.push(spreadBps);
            customSpreads.sort((a, b) => a - b);

            // Generate curve data
            const curveData = generateCustomCurveData(spreadBps);
            const color = getColorForSpread(spreadBps);

            // Store in interpolatedData for table generation
            interpolatedData[spreadBps] = spendLevels5M.map((_, idx) => interpolateAtSpread(spreadBps, idx));

            // Add dataset to chart
            const newDataset = {
                label: `${(spreadBps / 100).toFixed(2)}% spread (custom)`,
                data: curveData,
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 3,
                pointRadius: 3,
                pointHoverRadius: 6,
                tension: 0.4,
                borderDash: [5, 5], // Dashed line to distinguish custom curves
                hidden: false
            };

            chart.data.datasets.push(newDataset);
            chart.update();

            // Add legend button
            const datasetIdx = chart.data.datasets.length - 1;
            addLegendButton(spreadBps, color, datasetIdx, true);

            // Add chip to custom spreads list
            updateCustomSpreadsChips();

            // Rebuild tables to include custom spread
            buildTables();

            // Clear input
            input.value = '';
        }

        function addLegendButton(spreadBps, color, datasetIdx, isCustom) {
            const btn = document.createElement('button');
            btn.className = 'legend-btn active';
            btn.style.borderColor = color;
            btn.style.color = color;
            btn.id = `legend-btn-${spreadBps}`;
            btn.innerHTML = `<span class="dot" style="background: ${color}"></span>${(spreadBps/100).toFixed(2)}%${isCustom ? ' ‚òÖ' : ''}`;

            btn.addEventListener('click', function() {
                const meta = chart.getDatasetMeta(datasetIdx);
                meta.hidden = meta.hidden === null ? true : !meta.hidden;
                btn.classList.toggle('active', !meta.hidden);
                chart.update();
            });

            legendContainer.appendChild(btn);
        }

        function updateCustomSpreadsChips() {
            const container = document.getElementById('customSpreadsChips');
            const listContainer = document.getElementById('customSpreadsList');

            if (customSpreads.length === 0) {
                listContainer.style.display = 'none';
                return;
            }

            listContainer.style.display = 'block';
            container.innerHTML = '';

            customSpreads.forEach(spreadBps => {
                const chip = document.createElement('span');
                chip.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 10px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 12px;
                    font-size: 12px;
                `;
                chip.innerHTML = `${(spreadBps/100).toFixed(2)}% <button onclick="removeCustomSpread(${spreadBps})" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:14px;">√ó</button>`;
                container.appendChild(chip);
            });
        }

        function removeCustomSpread(spreadBps) {
            const idx = customSpreads.indexOf(spreadBps);
            if (idx === -1) return;

            customSpreads.splice(idx, 1);

            // Find and remove dataset
            const datasetIdx = chart.data.datasets.findIndex(d => d.label.includes(`${(spreadBps/100).toFixed(2)}%`) && d.label.includes('custom'));
            if (datasetIdx !== -1) {
                chart.data.datasets.splice(datasetIdx, 1);
                chart.update();
            }

            // Remove legend button
            const btn = document.getElementById(`legend-btn-${spreadBps}`);
            if (btn) btn.remove();

            // Remove from interpolatedData
            delete interpolatedData[spreadBps];

            // Update chips and tables
            updateCustomSpreadsChips();
            buildTables();
        }

        // Update buildTables to include custom spreads
        const originalBuildTables = buildTables;
        buildTables = function() {
            
            // Combine and sort all spreads
            const allSpreads = [...spreadLevels, ...customSpreads].sort((a, b) => a - b);

            // mCAC Table
            const mcacTableEl = document.getElementById('mcacTable');
            let mcacHeaderHtml = '<thead><tr><th>Spread</th>';
            for (let i = 1; i < spendLevels5M.length; i++) {
                mcacHeaderHtml += `<th>$${spendLevels5M[i-1]}-${spendLevels5M[i]}M</th>`;
            }
            mcacHeaderHtml += '</tr></thead>';

            let mcacBodyHtml = '<tbody>';
            allSpreads.forEach((spread) => {
                const isCustom = customSpreads.includes(spread);
                const color = isCustom ? getColorForSpread(spread) : colors[spreadLevels.indexOf(spread)];
                mcacBodyHtml += `<tr><td><span class="spread-label"><span class="spread-dot" style="background: ${color}"></span>${(spread/100).toFixed(2)}%${isCustom ? ' ‚òÖ' : ''}</span></td>`;

                const contracts = interpolatedData[spread];
                for (let i = 1; i < spendLevels5M.length; i++) {
                    const mcac = calcMCAC(contracts, i);
                    const { display, colorClass } = formatValue(mcac);
                    mcacBodyHtml += `<td class="${colorClass}">${display}</td>`;
                }
                mcacBodyHtml += '</tr>';
            });
            mcacBodyHtml += '</tbody>';
            mcacTableEl.innerHTML = mcacHeaderHtml + mcacBodyHtml;

            // iCAC Table
            const icacTableEl = document.getElementById('icacTable');
            let icacHeaderHtml = '<thead><tr><th>Spread</th>';
            for (let i = 1; i < spendLevels5M.length; i++) {
                icacHeaderHtml += `<th>$${spendLevels5M[i]}M</th>`;
            }
            icacHeaderHtml += '</tr></thead>';

            let icacBodyHtml = '<tbody>';
            allSpreads.forEach((spread) => {
                const isCustom = customSpreads.includes(spread);
                const color = isCustom ? getColorForSpread(spread) : colors[spreadLevels.indexOf(spread)];
                icacBodyHtml += `<tr><td><span class="spread-label"><span class="spread-dot" style="background: ${color}"></span>${(spread/100).toFixed(2)}%${isCustom ? ' ‚òÖ' : ''}</span></td>`;

                const contracts = interpolatedData[spread];
                const baseContracts = contracts[0];
                for (let i = 1; i < spendLevels5M.length; i++) {
                    const icac = calcICAC(contracts, i, baseContracts);
                    const { display, colorClass } = formatValue(icac);
                    icacBodyHtml += `<td class="${colorClass}">${display}</td>`;
                }
                icacBodyHtml += '</tr>';
            });
            icacBodyHtml += '</tbody>';
            icacTableEl.innerHTML = icacHeaderHtml + icacBodyHtml;
        };

        // Allow Enter key to add spread
        document.getElementById('customSpread').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCustomSpread();
        });

        // Dev Mode
        let devModeEnabled = false;

        function toggleDevMode() {
            devModeEnabled = !devModeEnabled;
            const panel = document.getElementById('devPanel');
            const btn = document.getElementById('devModeBtn');

            panel.style.display = devModeEnabled ? 'block' : 'none';
            btn.classList.toggle('active', devModeEnabled);

            if (devModeEnabled) {
                populateDevPanel();
            }
        }

        function populateDevPanel() {
            // Raw data table
            let rawTable = 'CONTRACTS BY SPREAD (bps) AND MARKETING SPEND ($M)\n';
            rawTable += '‚îÄ'.repeat(90) + '\n';
            rawTable += 'Spend ($M)'.padEnd(12) + spreadLevels.map(s => s.toString().padStart(10)).join('') + '\n';
            rawTable += '‚îÄ'.repeat(90) + '\n';
            spendLevelsRaw.forEach(spend => {
                rawTable += spend.toString().padEnd(12) + contractsRaw[spend].map(c => c.toLocaleString().padStart(10)).join('') + '\n';
            });
            document.getElementById('rawDataTable').textContent = rawTable;

            // Threshold calculation
            document.getElementById('thresholdCalc').textContent =
                `At $${avgHomePrice.toLocaleString()} home price: green ‚â§ $${(avgHomePrice * 0.02).toLocaleString()}, yellow ‚â§ $${(avgHomePrice * 0.04).toLocaleString()}, red > $${(avgHomePrice * 0.04).toLocaleString()}`;

            // Interpolated data table
            let interpTable = 'INTERPOLATED CONTRACTS AT $5M INTERVALS\n';
            interpTable += '‚îÄ'.repeat(100) + '\n';
            interpTable += 'Spend'.padEnd(8) + spreadLevels.map(s => (s/100).toFixed(2) + '%').map(s => s.padStart(12)).join('') + '\n';
            interpTable += '‚îÄ'.repeat(100) + '\n';
            spendLevels5M.forEach((spend, idx) => {
                interpTable += ('$' + spend + 'M').padEnd(8) + spreadLevels.map(s => interpolatedData[s][idx].toLocaleString().padStart(12)).join('') + '\n';
            });
            document.getElementById('interpolatedDataTable').textContent = interpTable;

            // Sample mCAC calculation
            const sampleSpread = 1139;
            const sampleSpendIdx = 8; // $40M
            const contracts40 = interpolatedData[sampleSpread][sampleSpendIdx];
            const contracts35 = interpolatedData[sampleSpread][sampleSpendIdx - 1];
            const sampleMcac = 5000000 / (contracts40 - contracts35);

            let sampleHtml = `
                <div class="dev-formula">
                    <p><strong>Example: mCAC at 11.39% spread, $35M‚Üí$40M tranche</strong></p>
                    <p>Contracts at $40M: <code>${contracts40.toLocaleString()}</code></p>
                    <p>Contracts at $35M: <code>${contracts35.toLocaleString()}</code></p>
                    <p>Incremental contracts: <code>${contracts40.toLocaleString()} - ${contracts35.toLocaleString()} = ${(contracts40 - contracts35).toLocaleString()}</code></p>
                    <p>mCAC = <code>$5,000,000 / ${(contracts40 - contracts35).toLocaleString()} = $${Math.round(sampleMcac).toLocaleString()}</code></p>
                    <p>As % of home price: <code>$${Math.round(sampleMcac).toLocaleString()} / $${avgHomePrice.toLocaleString()} = ${(sampleMcac / avgHomePrice * 100).toFixed(2)}%</code></p>
                </div>
            `;
            document.getElementById('sampleCalc').innerHTML = sampleHtml;

            // Custom spread debug
            updateCustomSpreadDebug();
        }

        function updateCustomSpreadDebug() {
            const debugSection = document.getElementById('customSpreadDebug');
            const calcsDiv = document.getElementById('customSpreadCalcs');

            if (customSpreads.length === 0) {
                debugSection.style.display = 'none';
                return;
            }

            debugSection.style.display = 'block';

            let html = '';
            customSpreads.forEach(spreadBps => {
                const spreadPct = (spreadBps / 100).toFixed(2);

                // Show interpolation at a sample spend level ($40M = index 8)
                const spendIdx = 8;
                const spendLevel = spendLevels5M[spendIdx];

                // Get contracts at this spend for all base spreads
                const baseContracts = spreadLevels.map(s => interpolatedData[s][spendIdx]);

                // Find bracketing spreads
                let lowerIdx = 0, upperIdx = 1;
                for (let i = 0; i < spreadLevels.length - 1; i++) {
                    if (spreadBps >= spreadLevels[i] && spreadBps <= spreadLevels[i + 1]) {
                        lowerIdx = i;
                        upperIdx = i + 1;
                        break;
                    }
                }

                const lowerSpread = spreadLevels[lowerIdx];
                const upperSpread = spreadLevels[upperIdx];
                const lowerContracts = baseContracts[lowerIdx];
                const upperContracts = baseContracts[upperIdx];
                const interpolatedContracts = interpolatedData[spreadBps][spendIdx];

                html += `
                    <div class="dev-formula" style="margin-bottom: 12px;">
                        <p><strong>Custom Spread: ${spreadPct}% (${spreadBps} bps)</strong></p>
                        <p>At $${spendLevel}M spend:</p>
                        <p style="margin-left: 16px;">
                            Bracketing spreads: <code>${(lowerSpread/100).toFixed(2)}%</code> (${lowerContracts.toLocaleString()} contracts)
                            ‚Üî <code>${(upperSpread/100).toFixed(2)}%</code> (${upperContracts.toLocaleString()} contracts)
                        </p>
                        <p style="margin-left: 16px;">
                            Cubic spline interpolation result: <code>${interpolatedContracts.toLocaleString()}</code> contracts
                        </p>
                        <p class="dev-note">Full curve uses cubic spline across all 7 spread data points for smooth interpolation</p>
                    </div>
                `;
            });

            calcsDiv.innerHTML = html;
        }

        // Update dev panel when custom spreads change
        const originalAddCustomSpread = addCustomSpread;
        addCustomSpread = function() {
            originalAddCustomSpread();
            if (devModeEnabled) updateCustomSpreadDebug();
        };

        const originalRemoveCustomSpread = removeCustomSpread;
        removeCustomSpread = function(spreadBps) {
            originalRemoveCustomSpread(spreadBps);
            if (devModeEnabled) updateCustomSpreadDebug();
        };
    </script>
</body>
</html>
